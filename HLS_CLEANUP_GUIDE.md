# HLS Folder Management - Auto Cleanup & Creation

## âœ… What's Fixed

### **Problem**:
- HLS folders (live1, live2, etc.) were not being cleaned up when channels were deleted
- Old HLS files remained on disk indefinitely
- Clutter and wasted storage space

### **Solution**:
- **Auto-delete HLS folders** when channels are deleted
- **Auto-create HLS folders** when channels are created
- Clean and organized file structure

---

## ğŸ”„ How It Works Now

### **When You CREATE a Channel**:

```
1. Channel created in database
2. Creates videos/channel{N}/ directory
3. Creates hls/live{N}/ directory  â† NEW!
4. Ready for streaming!
```

**Example**:
```bash
Create "Channel 5"
  â”œâ”€â”€ videos/channel5/     âœ… Created
  â”œâ”€â”€ hls/live5/           âœ… Created (NEW!)
  â””â”€â”€ playlists/playlist5.txt  âœ… Will be created when videos added
```

---

### **When You DELETE a Channel**:

```
1. Stop the stream (if running)
2. Delete videos/channel{N}/ and all video files
3. Delete playlists/playlist{N}.txt
4. Delete logs/live{N}.log
5. Delete hls/live{N}/ and all HLS files  â† NEW!
6. Remove channel from database
```

**Example**:
```bash
Delete "Channel 5"
  â”œâ”€â”€ videos/channel5/     âŒ Deleted
  â”œâ”€â”€ hls/live5/           âŒ Deleted (NEW!)
  â”œâ”€â”€ playlists/playlist5.txt  âŒ Deleted
  â””â”€â”€ logs/live5.log       âŒ Deleted
```

**Result**: Clean slate! No leftover files.

---

## ğŸ“‚ HLS Folder Structure

### **What's Inside an HLS Folder**:

```
hls/
â”œâ”€â”€ live1/
â”‚   â”œâ”€â”€ stream.m3u8          â† Playlist file
â”‚   â”œâ”€â”€ stream0.ts           â† Video segment
â”‚   â”œâ”€â”€ stream1.ts
â”‚   â”œâ”€â”€ stream2.ts
â”‚   â””â”€â”€ ...                  â† More segments
â”œâ”€â”€ live2/
â”‚   â””â”€â”€ ...
â””â”€â”€ live10/
    â””â”€â”€ ...
```

**HLS File Types**:
- `.m3u8` - Playlist (indexes the segments)
- `.ts` - Transport Stream segments (video chunks)

**Generated by**: nginx-rtmp module during streaming

---

## ğŸ¯ Full Lifecycle

### **Complete Channel Lifecycle**:

#### **1. Create Channel**:
```
POST /api/channels
  â†“
Creates:
  â€¢ videos/channel{N}/    (for uploaded videos)
  â€¢ hls/live{N}/          (for HLS stream files)
  
Console:
  [CREATE] Created HLS directory: hls/live5
  [CREATE] Created videos directory: videos/channel5
```

#### **2. Add Videos**:
```
Upload videos
  â†“
Stored in:
  â€¢ videos/channel{N}/video.mp4
```

#### **3. Stream** (Streaming Active):
```
Start stream
  â†“
Generates in hls/live{N}/:
  â€¢ stream.m3u8  (updated every few seconds)
  â€¢ stream0.ts, stream1.ts, ...  (rolling segments)
```

#### **4. Stop Stream**:
```
Stop stream
  â†“
HLS files remain:
  â€¢ hls/live{N}/stream.m3u8
  â€¢ hls/live{N}/stream*.ts
  
(Files stay until channel is deleted)
```

#### **5. Delete Channel**:
```
DELETE /api/channels/:id
  â†“
Deletes:
  â€¢ videos/channel{N}/       â† All video files
  â€¢ hls/live{N}/             â† All HLS files (NEW!)
  â€¢ playlists/playlist{N}.txt
  â€¢ logs/live{N}.log
  
Console:
  [DELETE] Removed HLS directory: hls/live5
  [DELETE] Removed channel directory: videos/channel5
```

---

## ğŸ’¡ Benefits

### **Before** (Old Behavior):
```
âŒ HLS folders stayed forever
âŒ Old .m3u8 and .ts files accumulated
âŒ Disk space wasted
âŒ Confusing leftover folders
âŒ Manual cleanup needed
```

### **After** (New Behavior):
```
âœ… HLS folders auto-deleted
âœ… Clean file system
âœ… No wasted space
âœ… Organized structure
âœ… Fully automated!
```

---

## ğŸ” Technical Details

### **HLS Directory Location**:

**In Docker**:
```
/var/www/html/hls/
â”œâ”€â”€ live1/
â”œâ”€â”€ live2/
...
â””â”€â”€ live10/
```

**In Your Project** (when running locally):
```
hls/
â”œâ”€â”€ live1/
â”œâ”€â”€ live2/
...
â””â”€â”€ live10/
```

### **Code Implementation**:

**On Create** (`api-server.js`):
```javascript
// Create HLS directory for this channel
const hlsChannelDir = path.join(HLS_DIR, `live${newId}`);
if (!fs.existsSync(hlsChannelDir)) {
    fs.mkdirSync(hlsChannelDir, { recursive: true });
    console.log(`[CREATE] Created HLS directory: ${hlsChannelDir}`);
}
```

**On Delete** (`api-server.js`):
```javascript
// Delete HLS directory and all its files
const hlsChannelDir = path.join(HLS_DIR, `live${channelId}`);
if (fs.existsSync(hlsChannelDir)) {
    const hlsFiles = fs.readdirSync(hlsChannelDir);
    hlsFiles.forEach(file => {
        fs.unlinkSync(path.join(hlsChannelDir, file));
    });
    fs.rmdirSync(hlsChannelDir);
    console.log(`[DELETE] Removed HLS directory: ${hlsChannelDir}`);
}
```

---

## ğŸ§ª Testing

### **Test Create**:

1. **Create a new channel**:
   ```
   http://localhost/admin-v2.html
   â†’ Create New Channel
   ```

2. **Check console/logs**:
   ```
   [CREATE] Created HLS directory: hls/live11
   [CREATE] Created videos directory: videos/channel11
   ```

3. **Verify folders exist**:
   ```bash
   ls -la hls/       # Should show live11/
   ls -la videos/    # Should show channel11/
   ```

---

### **Test Delete**:

1. **Delete the channel**:
   ```
   http://localhost/admin-v2.html
   â†’ Delete Channel (ğŸ—‘ï¸ button)
   ```

2. **Check console/logs**:
   ```
   [DELETE] Removed HLS directory: hls/live11
   [DELETE] Removed channel directory: videos/channel11
   ```

3. **Verify folders are gone**:
   ```bash
   ls -la hls/       # live11/ should be GONE
   ls -la videos/    # channel11/ should be GONE
   ```

---

## ğŸ“ Summary

### **What Changed**:

**api-server.js**:
1. âœ… Added `HLS_DIR` constant
2. âœ… Create HLS folder on channel creation
3. âœ… Delete HLS folder on channel deletion
4. âœ… Console logging for both actions

### **What It Fixes**:

| Issue | Before | After |
|-------|--------|-------|
| **HLS cleanup** | âŒ Manual | âœ… Automatic |
| **Disk space** | âŒ Wasted | âœ… Optimized |
| **File organization** | âŒ Messy | âœ… Clean |
| **Leftover folders** | âŒ Many | âœ… None |

---

## ğŸ‰ Result

**Now when you**:
- Create a channel â†’ HLS folder created automatically
- Delete a channel â†’ HLS folder deleted automatically
- No manual cleanup needed
- Clean, organized file structure
- Storage space optimized

**Your file structure is now fully managed!** ğŸš€

---

## ğŸ“‚ Complete File Structure

### **After Creating 3 Channels**:

```
project/
â”œâ”€â”€ videos/
â”‚   â”œâ”€â”€ channel1/
â”‚   â”œâ”€â”€ channel2/
â”‚   â””â”€â”€ channel3/
â”œâ”€â”€ hls/
â”‚   â”œâ”€â”€ live1/
â”‚   â”œâ”€â”€ live2/
â”‚   â””â”€â”€ live3/
â”œâ”€â”€ playlists/
â”‚   â”œâ”€â”€ playlist1.txt
â”‚   â”œâ”€â”€ playlist2.txt
â”‚   â””â”€â”€ playlist3.txt
â””â”€â”€ logs/
    â”œâ”€â”€ live1.log
    â”œâ”€â”€ live2.log
    â””â”€â”€ live3.log
```

### **After Deleting Channel 2**:

```
project/
â”œâ”€â”€ videos/
â”‚   â”œâ”€â”€ channel1/
â”‚   â””â”€â”€ channel3/        â† channel2 GONE
â”œâ”€â”€ hls/
â”‚   â”œâ”€â”€ live1/
â”‚   â””â”€â”€ live3/           â† live2 GONE!
â”œâ”€â”€ playlists/
â”‚   â”œâ”€â”€ playlist1.txt
â”‚   â””â”€â”€ playlist3.txt    â† playlist2 GONE
â””â”€â”€ logs/
    â”œâ”€â”€ live1.log
    â””â”€â”€ live3.log        â† live2.log GONE
```

**Perfect cleanup!** âœ¨

---

**Files Updated**:
- âœ… `api-server.js` - HLS folder management added

**Ready to test!** Restart your server to apply the changes.
