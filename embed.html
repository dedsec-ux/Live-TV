<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INBV Live Stream</title>
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            overflow: hidden;
        }

        #embed-player {
            width: 100vw;
            height: 100vh;
        }

        .video-js {
            width: 100%;
            height: 100%;
        }

        .vjs-big-play-button {
            display: none !important;
        }

        /* Hide the 'Line' (Progress Control) */
        .vjs-progress-control {
            display: none !important;
        }

        /* Premium Logo Styling */
        .player-logo {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 10px;
            pointer-events: none;
            user-select: none;
        }

        .player-logo img {
            height: 50px;
            width: auto;
            filter: drop-shadow(0 0 10px rgba(0, 0, 0, 0.5));
        }

        .logo-text {
            color: white;
            font-family: 'Arial Black', sans-serif;
            font-size: 24px;
            letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            font-weight: 900;
        }

        .logo-live-dot {
            width: 10px;
            height: 10px;
            background: #ff4757;
            border-radius: 50%;
            box-shadow: 0 0 10px #ff4757;
            animation: pulse-red 2s infinite;
        }

        @keyframes pulse-red {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7);
            }

            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(255, 71, 87, 0);
            }

            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(255, 71, 87, 0);
            }
        }
    </style>
</head>

<body>
    <div class="player-logo">
        <div class="logo-live-dot"></div>
        <img src="INBV MEDIA LOGO ONLY.png" alt="INBV">
    </div>
    <video id="embed-player" class="video-js vjs-default-skin" controls autoplay muted playsinline></video>

    <script>
        // Get channel ID from URL parameter or default to 1
        const urlParams = new URLSearchParams(window.location.search);
        const channelId = urlParams.get('channel') || '1';
        const autoplay = urlParams.get('autoplay') !== '0'; // Default true
        const muted = urlParams.get('muted') !== '0'; // Default true for autoplay


        // Build stream URL
        const streamUrl = `${window.location.origin}/hls/live${channelId}/stream.m3u8`;
        // Initialize player
        const player = videojs('embed-player', {
            controls: true,
            autoplay: autoplay,
            muted: muted,
            preload: 'auto',
            liveui: true,
            fluid: false,
            fill: true,
            responsive: true,
            controlBar: {
                pictureInPictureToggle: true,
                fullscreenToggle: true
            }
        });

        // Set source
        player.src({
            src: streamUrl,
            type: 'application/x-mpegURL'
        });

        // Auto-retry on errors
        let retryCount = 0;
        const maxRetries = 5;

        player.on('error', function () {
            const error = player.error();
            console.error('Stream error:', error);

            // Handle corruption/decode errors specifically
            const isCorruption = error && (error.code === 3 || error.code === 4);

            if (retryCount < maxRetries) {
                retryCount++;
                const delay = isCorruption ? 1000 : (2000 * retryCount);
                console.log(`Retrying... (${retryCount}/${maxRetries}) - ${isCorruption ? 'Fixing Corruption' : 'Reconnecting'}`);

                setTimeout(() => {
                    if (isCorruption && retryCount > 2) {
                        // If it keeps failing, refresh the whole stream link
                        console.log('Performing hard stream reset...');
                        player.src({
                            src: streamUrl + '?t=' + new Date().getTime(),
                            type: 'application/x-mpegURL'
                        });
                    } else {
                        player.src({ src: streamUrl, type: 'application/x-mpegURL' });
                    }
                    player.load();
                    if (autoplay) {
                        player.play().catch(e => console.log('Autoplay prevented'));
                    }
                }, delay);
            }
        });

        // Reset retry count on success
        player.on('playing', function () {
            retryCount = 0;
            console.log('Stream playing successfully');
        });


        // Start playback
        player.ready(function () {
            if (autoplay) {
                player.play().catch(function (error) {
                    console.log('Autoplay was prevented. Unmute and click play.');
                    // If autoplay fails, show play button
                    player.muted(false);
                });
            }
        });

        // Maintain live edge
        player.on('timeupdate', function () {
            const liveTracker = player.liveTracker;
            if (liveTracker && liveTracker.isLive() && !liveTracker.atLiveEdge()) {
                // If we're more than 10 seconds behind live, jump to live edge
                const behindLive = liveTracker.liveCurrentTime() - player.currentTime();
                if (behindLive > 10) {
                    player.currentTime(liveTracker.seekableEnd());
                }
            }
        });
    </script>
</body>

</html>